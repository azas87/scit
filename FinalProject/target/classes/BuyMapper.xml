<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kay87.team.dao.BuyMapper">
	
<!-- 검색한 생선리스트 가져오기 -->
	<select id="getFishName" parameterType="string" resultType="FishList">
		
		select * from fishList
		where fishName LIKE '%' || #{search} || '%'
	
	</select>
	
<!-- 구매글 올리기	 -->
	<insert id="insertBuyList" parameterType="BuyList">
	
		insert into buyList
		(
			buyNum
			, fishName
			, buyerId
			<if test="uploadDate !=null">
			, uploadDate
			</if>
			, deadline
			, weight
			, price
			<if test="buyListComment !=null">
			, buyListComment
			</if>
			, location
		)
		values
		(
			buyNum.nextval
			, #{fishName}
			, #{buyerId}
			<if test="uploadDate !=null">
			, TO_DATE(#{uploadDate}, 'yyyy/mm/dd hh24:mi:ss')
			</if>
			, TO_DATE(#{deadline}, 'yyyy/mm/dd hh24:mi:ss')
			, #{weight}
			, #{price}
			<if test="buyListComment !=null">
			, #{buyListComment}
			</if>
			, #{location}
		)

	</insert>
	
	<insert id="insertPriority" parameterType="PriorityList">

	INSERT INTO priorityList VALUES(priorityNum.nextval, buyNum.nextval-1, #{priorityId},#{orders})
	
	</insert>
	
	<insert id="insertPriority2" parameterType="PriorityList">

	INSERT INTO priorityList VALUES(priorityNum.nextval, buyNum.nextval-2, #{priorityId},#{orders})
	
	</insert>
	
	<insert id="insertPriority3" parameterType="PriorityList">

	INSERT INTO priorityList VALUES(priorityNum.nextval, buyNum.nextval-3, #{priorityId},#{orders})
	
	</insert>

	<!-- 사용자의 판매이력 가져오기(중복된 판매자는 제외) 
	판매자 우선순위를 위해-->
	<select id="getHistorySellerId" parameterType="string" resultType="BuyList">
		
		SELECT * FROM buyList 
 		WHERE ROWID IN(SELECT MAX(ROWID) FROM buyList 
 		where buyerid = #{id}
 		GROUP BY successsellerId) 
 		and successsellerId is not null
 		
	</select>
	
	<!-- 구매이력 가져오기 -->
	<select id="getSuccessBuyList" parameterType="map" resultType="BuyList">
	
			SELECT
				buyNum,
				fishName,
				buyerId,
				TO_CHAR(registDate, 'YYYY-MM-DD') as registDate,
				TO_CHAR(uploadDate, 'YYYY-MM-DD') as uploadDate,
				TO_CHAR(deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline,
				weight,
				saleStatus,
				price,
				successSellerId,
				buyListComment,
				location 
			FROM 
				buyList
				
			WHERE buyerId = #{id}
			
			AND 
                (saleStatus = 'saleComplete'
            OR
            	saleStatus = 'getComplete')
   			<if test="period !=null and period=='1week'">
            AND 
            	deadline >= sysdate-7
            </if>
            <if test="period !=null and period=='3week'">
            AND 
            	deadline >= sysdate-21
            </if>
            <if test="period !=null and period=='1month'">
            AND 
            	deadline >= sysdate-30
            </if>
             <if test="period !=null and period=='1year'">
            AND 
            	deadline >= sysdate-365
            </if>
            <if test="startDay !=null">
            <![CDATA[
            AND 
            	deadline >= #{startDay}
        	AND 
            	deadline <= #{endDay}
             ]]>
            </if>
            
	
	</select>
	
	
	<select id="getSuccessSellList"  parameterType="map" resultType="BuyList">
	
	SELECT		
				buyerid,
				buyNum,
				fishName,
				buyerId,
				TO_CHAR(registDate, 'YYYY-MM-DD') as registDate,
				TO_CHAR(uploadDate, 'YYYY-MM-DD') as uploadDate,
				TO_CHAR(deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline,
				weight,
				saleStatus,
				price,
				successSellerId,
				buyListComment,
				location 
			FROM 
				buyList
				
			WHERE successSellerId = #{id}
			
			AND 
                (saleStatus = 'saleComplete'
            OR
            	saleStatus = 'getComplete')
   			<if test="period !=null and period=='1week'">
            AND 
            	deadline >= sysdate-7
            </if>
            <if test="period !=null and period=='3week'">
            AND 
            	deadline >= sysdate-21
            </if>
            <if test="period !=null and period=='1month'">
            AND 
            	deadline >= sysdate-30
            </if>
             <if test="period !=null and period=='1year'">
            AND 
            	deadline >= sysdate-365
            </if>
            <if test="startDay !=null">
            <![CDATA[
            AND 
            	deadline >= #{startDay}
        	AND 
            	deadline <= #{endDay}
             ]]>
            </if>

	</select>
	
	<!-- 환불이력가져오기 -->
	<select id="getRefundsBuyList" parameterType="string" resultType="BuyList">
	
			SELECT
				buyNum,
				fishName,
				buyerId,
				TO_CHAR(registDate, 'YYYY-MM-DD') as registDate,
				TO_CHAR(uploadDate, 'YYYY-MM-DD') as uploadDate,
				TO_CHAR(deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline,
				weight,
				saleStatus,
				price,
				successSellerId,
				buyListComment,
				location 
			FROM 
				buyList
				
			WHERE buyerId = #{search}
			
			and 
                saleStatus ='refund'
	</select>

	
<!--전체구매리스트-->	
	<select id="allBuyList" resultType="BuyList" >

		SELECT 
			buyNum,
			fishName,
			buyerId,
			TO_CHAR(registDate, 'YYYY-MM-DD') as registDate,
			TO_CHAR(uploadDate, 'YYYY-MM-DD') as uploadDate,
			TO_CHAR(deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline,
			weight,
			saleStatus,
			price,
			successSellerId,
			buyListComment,
			location 

		from 
			BuyList
		where			
			saleStatus = 'onSale'
		order by buyNum asc
	</select>
	
	
	
<!--구매자 진행중인 리스트-->		
	<select id="myList_ing_buyer" resultType="BuyList" parameterType="string">
		select 
			b.buyNum,
			fishName,
			buyerId,
			TO_CHAR(registDate, 'YYYY-MM-DD') as registDate,
			TO_CHAR(uploadDate, 'YYYY-MM-DD') as uploadDate,
			TO_CHAR(deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline,
			weight,
			saleStatus,
			price,
			s.sellerid as successSellerId,
			buyListComment,
			location 
		from BuyList b, SaleList s
		where b.buynum=s.buynum 
		and buyerId = #{userId}
		and saleStatus = 'onSale'	
		order by buyNum asc			
	</select>	
	

<!--판매자 참여리스트-->		
	<select id="myList_ing_seller" resultType="BuyList" parameterType="string">	
		select 
			b.buyNum,
			fishName,
			buyerId,
			TO_CHAR(registDate, 'YYYY-MM-DD') as registDate,
			TO_CHAR(uploadDate, 'YYYY-MM-DD') as uploadDate,
			TO_CHAR(deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline,
			weight,
			saleStatus,
			price,
			buyListComment,
			location 
		from BuyList b, (select * from SaleList where  sellerid=#{userId}) s
		where b.buynum = s.buyNum
		order by saleStatus asc
	</select>

<!--구매자 내글 목록-->		
 	<select id="myAllList_buyer" resultType="BuyList" parameterType="string">	
		SELECT 
			buyNum,
			fishName,
			buyerId,
			TO_CHAR(registDate, 'YYYY-MM-DD') as registDate,
			TO_CHAR(uploadDate, 'YYYY-MM-DD') as uploadDate,
			TO_CHAR(deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline,
			weight,
			saleStatus,
			price,
			successSellerId,
			buyListComment,
			location 

		from 
			BuyList
		where			
			buyerId=#{userId}
		order by buyNum asc
	</select>
	
<!--판매자 나의 모든리스트-->		
<!-- 	<select id="myAllList_seller" resultType="BuyList" parameterType="string">	
		SELECT 
			buyNum,
			fishName,
			buyerId,
			TO_CHAR(registDate, 'YYYY-MM-DD') as registDate,
			TO_CHAR(uploadDate, 'YYYY-MM-DD') as uploadDate,
			TO_CHAR(deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline,
			weight,
			saleStatus,
			price,
			successSellerId,
			buyListComment,
			location 

		from 
			BuyList
		where			
			buyerId=#{userId}
		order by buyNum asc
	</select> -->


	<select id="GetTotalListCount" resultType="int" parameterType="string">
		SELECT COUNT(*) FROM buyList <if test="_parameter != null"> WHERE buyerId = #{search}  </if>
	</select>
	
	<select id="GetTotalRefundListCount" resultType="int" parameterType="string">
		SELECT COUNT(*) FROM buyList <if test="_parameter != null"> WHERE buyerId = #{search}  </if>
		AND saleStatus = 'refund'
	</select>
	
	<!-- 생선별 구매 합계 -->
	<select id="sumPricebyFishName" parameterType="map" resultType="BuyList">
		SELECT SUM(price) as price ,fishName
			FROM 
				buyList
	 		where 
	 			buyerid = #{id}
	 		AND 
                (saleStatus = 'saleComplete'
            OR
            	saleStatus = 'getComplete')
            <if test="period !=null and period=='1week'">
            AND 
            	deadline >= sysdate-7
            </if>
            <if test="period !=null and period=='3week'">
            AND 
            	deadline >= sysdate-21
            </if>
            <if test="period !=null and period=='1month'">
            AND 
            	deadline >= sysdate-30
            </if>
           
             <if test="period !=null and period=='1year'">
            AND 
            	deadline >= sysdate-365
            </if>
             
            <if test="startDay !=null">
            <![CDATA[
            AND 
            	deadline >= #{startDay}
        	AND 
            	deadline <= #{endDay}
             ]]>
            </if>
            group by 
                fishName
    </select>
    
    <select id="sumPricebyFishNameForSeller" parameterType="map" resultType="BuyList">
		SELECT SUM(price) as price ,fishName
			FROM 
				buyList
	 		where 
	 			successSellerId = #{id}
	 		AND 
                (saleStatus = 'saleComplete'
            OR
            	saleStatus = 'getComplete')
            <if test="period !=null and period=='1week'">
            AND 
            	deadline >= sysdate-7
            </if>
            <if test="period !=null and period=='3week'">
            AND 
            	deadline >= sysdate-21
            </if>
            <if test="period !=null and period=='1month'">
            AND 
            	deadline >= sysdate-30
            </if>
           
             <if test="period !=null and period=='1year'">
            AND 
            	deadline >= sysdate-365
            </if>
             
            <if test="startDay !=null">
            <![CDATA[
            AND 
            	deadline >= #{startDay}
        	AND 
            	deadline <= #{endDay}
             ]]>
            </if>
            group by 
                fishName
    </select>
    
    
    <!-- 월별 구매합계 -->
    <select id="sumPricebyMonth" parameterType="string" resultType="BuyList">
		select
   			 to_char(deadline, 'MM') as fishName, sum(price) as price
		from
    		buylist
		where 
    		to_char(deadline, 'YYYYMMDD') between sysdate-365 and sysdate
		and
   			buyerid = #{id}
		AND 
                (saleStatus = 'saleComplete'
            OR
            	saleStatus = 'getComplete')
		group by 
		    to_char(deadline, 'MM')
		order by
 		   fishName
    </select>
    
      <select id="sumPricebyMonthBySeller" parameterType="string" resultType="BuyList">
		select
   			 to_char(deadline, 'MM') as fishName, sum(price) as price
		from
    		buylist
		where 
    		to_char(deadline, 'YYYYMMDD') between sysdate-365 and sysdate
		and
   			successSellerId = #{id}
		AND 
                (saleStatus = 'saleComplete'
            OR
            	saleStatus = 'getComplete')
		group by 
		    to_char(deadline, 'MM')
		order by
 		   fishName
    </select>
    
    <!-- 수취확인 -->
	<update id="saleComplete" parameterType="string">
 
  	 	UPDATE buylist
     	SET saleStatus = 'getComplete'
    	WHERE buyNum = #{buyNum}

	</update>
	

	<!-- 판매자 선택  -->
	<update id="selectSeller" parameterType="map"><!--parameter로 buyNum과 선택한 판매자id를 컨트롤러에 가져가야해서 map사용했음  -->
		UPDATE buylist
     	SET saleStatus = 'saleComplete'
     		,successSellerId=#{SellerId}
    	WHERE buyNum = #{buyNum}
	</update>
	
	<!--구매자 선택  -->
	<insert id="selectBuyer" parameterType="SaleList">
		INSERT into SaleList
     	(saleNum,buyNum,sellerId)
     	values
     	(saleNum.nextval,#{buyNum},#{sellerId})
	</insert>
	
	<!--구매자 선택 표시 /구매자를 선택했으면 '選択'표시되면안됨, 선택전의 구매글에는 '選択'가 표시되어야함 -->
	<select id="selectSaleList" parameterType="string" resultType="SaleList">
		select 
			saleNum,buyNum,sellerId 
		from 
			SaleList 
		where 
			sellerId=#{sellerId}
	</select>
	
	
	
	
	<update id="refund" parameterType="string">
 
  	 	UPDATE buylist
     	SET saleStatus = 'refund'
    	WHERE buyNum = #{buyNum}

	</update>
	

	<!--구매자 구매목록에서 글삭제  -->
	<delete id="deleteMyList_buyer" parameterType="string">
		delete 
			BuyList 
		where 
			buyNum=#{buyNum} 		
	</delete>
	
	<!--판매자 구매목록에서 글삭제(취소 cancel)-->
	<delete id="deleteMyList_seller" parameterType="string">
		delete 
			saleList
		where 
			buyNum=#{buyNum} 		
	</delete>


	<select id="getTodayAvgList" resultType="AvgList">
		select f.fishName,nvl(sum(b.PRICE),0) as total, nvl(sum(b.WEIGHT),0) as weight, nvl(trunc((SUM(price)/count(*))),0) as avgprice, TO_DATE(b.deadline, 'YY/MM/DD') as dates
		from fishList f left outer join buyList b on(f.fishName = b.fishName)
		group by f.fishName, TO_DATE(b.deadline, 'YY/MM/DD') having TO_DATE(b.DEADLINE, 'YY/MM/DD') = TO_date(sysdate, 'YY/MM/DD') order by f.fishName
		
	</select>
	
	<select id="getWeekAvgList" resultType="AvgList">
		<!-- select fishname,avgprice,dates from weekavglist order by dates, fishname -->
		select * from WEEKAVGLIST where fishname in('すずき','イセエビ','キダイ','キンメダイ','クマエビ') order by dates, fishname
	</select>
	
	<insert id="setWeekAvgList" parameterType="AvgList">
		insert into WEEKAVGLIST
		(
			AvgListNum
			,fishName
			, avgPrice
			, dates
		)
		values
		(
			avgListNum.nextval
			,#{fishName}
			,#{avgPrice}
			,sysdate
		)
	</insert>
	
	<select id="sellerWishList" resultType="BuyList" parameterType="string">
		SELECT 
			buyNum,
			fishName,
			buyerId,
			TO_CHAR(registDate, 'YYYY-MM-DD') as registDate,
			TO_CHAR(uploadDate, 'YYYY-MM-DD') as uploadDate,
			TO_CHAR(deadline, 'YYYY-MM-DD HH24:MI:SS') as deadline,
			weight,
			saleStatus,
			price,
			successSellerId,
			buyListComment,
			location 

		from 
			BuyList b, wishlist w
		where			
			w.id = #{userid} 
			and w.wish=b.fishname
			and b.salestatus='onSale'
		order by b.buyNum asc
	</select>
	
	<select id="selectOneBuylist" parameterType="int" resultType="BuyList">
		
		SELECT * FROM buylist WHERE buyNum = #{value}
		
	</select>
	<!-- <insert id="insertTodayAvgList" parameterType="TodayAvgList">
		insert into buyList
		(
			avgListNum
			,fishName
			, avgPrice
			, date
		)
		values
		(
			avgListNum.nextval
			,fishName
			, avgPrice
			, to_char(sysdate,YYYY/MM/DD);
		)
	</insert> -->

	<select id="getMarketPrice" resultType="AvgList">
	
		SELECT fishName, to_number(to_char(dates, 'yyyymmdd')) as dates, avgPrice FROM WeekAvgList
		
	</select>
	
	<select id="getPriorityList" parameterType="int" resultType="PriorityList">

		select * from priorityList where buyNum = #{buyNum}
	
	</select>

	<select id="getSellerId" parameterType="int" resultType="SaleList">
	
		select * from salelist where buyNum = #{buyNum}
	
	</select>
	
	 <select id="getSellerStar" parameterType="int"  resultType="SellerInfo">
	  
	SELECT id 
	FROM 
      (SELECT 
			round(avg(star),0) as star, r.sellerId as id
		FROM 
			review r, salelist s
		WHERE 
			s.buyNum = #{buyNum} AND s.sellerId=r.sellerId 
		GROUP BY 
			r.sellerId)
    WHERE star IN 
    	(SELECT 
			max(avg(star)) as star
		FROM 
			review r, salelist s
		WHERE 
			s.buyNum = #{buyNum} AND s.sellerId=r.sellerId 
        GROUP BY 
			r.sellerId)
			
			
	</select>
	
	<select id="successCount" parameterType="string" resultType="int">
	
		 SELECT count(*) from buylist where successSellerID = #{value}
		 
	</select>
</mapper>